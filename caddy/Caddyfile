# SATL 3.0 - TLS 1.3 Reverse Proxy Configuration
# Purpose: Terminate TLS for SPO→CP channel (guard/middle/exit)
# Backend: uvicorn on localhost:19000/19001/19002 (HTTP)
# Frontend: TLS 1.3 on localhost:9000/9001/9002 (HTTPS)

# Global options
{
	# Auto HTTPS (self-signed for dev, Let's Encrypt for prod)
	auto_https disable_redirects

	# TLS configuration
	servers {
		protocols h1 h2
		timeouts {
			read_header 10s
			read_body 30s
			write 30s
			idle 120s
		}
	}
}

# Guard Node (port 9000 → 19000)
https://localhost:9000 {
	# TLS 1.3 only (post-quantum readiness)
	tls internal {
		protocols tls1.3
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		-Server
	}

	# Reverse proxy to uvicorn backend
	reverse_proxy localhost:19000 {
		# Health check
		health_uri /health
		health_interval 10s
		health_timeout 5s

		# Headers preservation
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-Proto {scheme}

		# Timeouts
		transport http {
			dial_timeout 5s
			response_header_timeout 30s
		}
	}

	# Logging (minimal for production)
	log {
		output file /var/log/caddy/guard.log
		level WARN
	}
}

# Middle Node (port 9001 → 19001)
https://localhost:9001 {
	tls internal {
		protocols tls1.3
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		-Server
	}

	reverse_proxy localhost:19001 {
		health_uri /health
		health_interval 10s
		health_timeout 5s

		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-Proto {scheme}

		transport http {
			dial_timeout 5s
			response_header_timeout 30s
		}
	}

	log {
		output file /var/log/caddy/middle.log
		level WARN
	}
}

# Exit Node (port 9002 → 19002)
https://localhost:9002 {
	tls internal {
		protocols tls1.3
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		-Server
	}

	reverse_proxy localhost:19002 {
		health_uri /health
		health_interval 10s
		health_timeout 5s

		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-Proto {scheme}

		transport http {
			dial_timeout 5s
			response_header_timeout 30s
		}
	}

	log {
		output file /var/log/caddy/exit.log
		level WARN
	}
}

# Health check endpoint (no TLS)
http://localhost:9999 {
	respond /health "OK" 200

	log {
		output file /var/log/caddy/health.log
		level ERROR
	}
}
